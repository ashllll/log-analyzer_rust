# 需求文档

## 简介

本文档定义了提取引擎（Extraction Engine）的核心实现需求。当前提取引擎的 `process_archive_file` 方法只有占位符实现，导致所有集成测试失败（提取的文件数为0）。需要实现完整的归档文件提取逻辑，支持ZIP、RAR、TAR和GZ格式，并与现有的路径管理、安全检测和嵌套归档处理系统集成。

## 术语表

- **ExtractionEngine**: 提取引擎，负责迭代处理归档文件的核心组件
- **ArchiveHandler**: 归档处理器，针对特定格式（ZIP、RAR、TAR、GZ）的提取实现
- **ExtractionItem**: 提取项，表示待处理的归档文件及其上下文信息
- **ExtractionStack**: 提取栈，用于管理嵌套归档的深度优先遍历
- **PathManager**: 路径管理器，处理长路径和路径映射
- **SecurityDetector**: 安全检测器，检测zip炸弹和路径遍历攻击
- **ExtractionPolicy**: 提取策略，定义深度限制、文件大小限制等配置

## 需求

### 需求 1

**用户故事:** 作为系统用户，我希望能够提取ZIP归档文件，以便访问其中的日志文件。

#### 验收标准

1. WHEN 用户提取一个ZIP归档文件 THEN 系统应当成功提取所有文件到目标目录
2. WHEN ZIP归档包含嵌套目录 THEN 系统应当保持目录结构
3. WHEN ZIP归档包含多个文件 THEN 系统应当提取所有文件并返回正确的文件路径列表
4. WHEN ZIP归档为空 THEN 系统应当返回空的文件列表而不报错
5. WHEN ZIP归档损坏 THEN 系统应当返回适当的错误信息

### 需求 2

**用户故事:** 作为系统用户，我希望能够提取嵌套的归档文件，以便访问深层嵌套的日志文件。

#### 验收标准

1. WHEN 归档文件包含另一个归档文件 THEN 系统应当识别并将嵌套归档添加到提取栈
2. WHEN 嵌套深度未超过限制 THEN 系统应当递归提取嵌套归档
3. WHEN 嵌套深度达到限制 THEN 系统应当停止提取并记录警告
4. WHEN 提取嵌套归档 THEN 系统应当正确跟踪当前深度级别

### 需求 3

**用户故事:** 作为系统用户，我希望系统能够处理长文件名，以便在Windows系统上正常工作。

#### 验收标准

1. WHEN 归档包含超过260字符的文件路径 THEN 系统应当使用PathManager缩短路径
2. WHEN 路径被缩短 THEN 系统应当在元数据数据库中记录映射关系
3. WHEN 路径被缩短 THEN 系统应当在结果中记录警告
4. WHEN 查询缩短的路径 THEN 系统应当能够通过PathManager恢复原始路径

### 需求 4

**用户故事:** 作为系统用户，我希望系统能够检测恶意归档文件，以便保护系统安全。

#### 验收标准

1. WHEN 归档文件包含路径遍历尝试（如"../../../etc/passwd"） THEN 系统应当拒绝提取该文件
2. WHEN 归档文件的压缩比异常高 THEN 系统应当使用SecurityDetector检测zip炸弹
3. WHEN 检测到安全威胁 THEN 系统应当停止提取并返回安全错误
4. WHEN 文件路径包含非法字符 THEN 系统应当清理或拒绝该路径

### 需求 5

**用户故事:** 作为系统用户，我希望系统能够支持多种归档格式，以便处理不同来源的日志文件。

#### 验收标准

1. WHEN 用户提取ZIP格式归档 THEN 系统应当使用ZipHandler处理
2. WHEN 用户提取RAR格式归档 THEN 系统应当使用RarHandler处理
3. WHEN 用户提取TAR格式归档 THEN 系统应当使用TarHandler处理
4. WHEN 用户提取GZ格式归档 THEN 系统应当使用GzHandler处理
5. WHEN 归档格式不支持 THEN 系统应当返回UnsupportedFormat错误

### 需求 6

**用户故事:** 作为系统用户，我希望系统能够高效地提取大型归档文件，以便快速访问日志数据。

#### 验收标准

1. WHEN 提取大文件 THEN 系统应当使用流式提取而非一次性加载到内存
2. WHEN 提取多个文件 THEN 系统应当使用配置的缓冲区大小进行批处理
3. WHEN 提取文件 THEN 系统应当遵守ExtractionPolicy中的max_file_size限制
4. WHEN 总提取大小超过限制 THEN 系统应当停止提取并返回错误
5. WHEN 提取完成 THEN 系统应当返回准确的性能指标（文件数、字节数）

### 需求 7

**用户故事:** 作为系统用户，我希望系统能够并行提取文件，以便提高提取速度。

#### 验收标准

1. WHEN 归档包含多个文件 THEN 系统应当使用Semaphore控制并行度
2. WHEN 并行提取文件 THEN 系统应当遵守max_parallel_files配置
3. WHEN 并行提取失败 THEN 系统应当记录警告但继续处理其他文件
4. WHEN 所有并行任务完成 THEN 系统应当正确聚合结果

### 需求 8

**用户故事:** 作为系统用户，我希望系统能够提供详细的提取结果，以便了解提取过程中发生的情况。

#### 验收标准

1. WHEN 提取完成 THEN 系统应当返回所有成功提取的文件路径列表
2. WHEN 提取过程中出现警告 THEN 系统应当在结果中包含所有警告信息
3. WHEN 提取完成 THEN 系统应当返回准确的统计信息（总文件数、总字节数、最大深度）
4. WHEN 路径被缩短 THEN 系统应当在结果中记录缩短次数
5. WHEN 达到深度限制 THEN 系统应当在结果中记录跳过的归档数量
