#!/bin/bash
# 本地 CI 验证脚本
# 在推送前运行此脚本，确保本地通过所有 CI 检查

set -e  # 遇到错误立即退出

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 项目根目录
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT/log-analyzer"

echo -e "${GREEN}=== 本地 CI 验证脚本 ===${NC}"
echo "项目路径: $PROJECT_ROOT"
echo ""

# 检查 Node 版本
NODE_VERSION=$(node -v)
echo -e "${YELLOW}Node 版本: $NODE_VERSION${NC}"
if [[ ! "$NODE_VERSION" =~ v22 ]]; then
  echo -e "${RED}⚠️  警告: CI 使用 Node 22，本地使用 $NODE_VERSION${NC}"
fi
echo ""

# ============================================================================
# 1. 前端 Lint 检查
# ============================================================================
echo -e "${GREEN}[1/6] 运行 ESLint...${NC}"
npm run lint
echo -e "${GREEN}✅ ESLint 通过${NC}"
echo ""

# ============================================================================
# 2. TypeScript 类型检查
# ============================================================================
echo -e "${GREEN}[2/6] 运行 TypeScript 类型检查...${NC}"
npm run type-check
echo -e "${GREEN}✅ 类型检查通过${NC}"
echo ""

# ============================================================================
# 3. 前端测试
# ============================================================================
echo -e "${GREEN}[3/6] 运行前端测试...${NC}"
NODE_ENV=test npm test -- --testPathIgnorePatterns=e2e --verbose
echo -e "${GREEN}✅ 前端测试通过${NC}"
echo ""

# ============================================================================
# 4. 前端构建
# ============================================================================
echo -e "${GREEN}[4/6] 构建前端...${NC}"
npm run build
echo -e "${GREEN}✅ 前端构建成功${NC}"
echo ""

# ============================================================================
# 5. Rust 格式检查
# ============================================================================
echo -e "${GREEN}[5/6] 检查 Rust 代码格式...${NC}"
cd src-tauri
cargo fmt -- --check
echo -e "${GREEN}✅ 代码格式检查通过${NC}"
echo ""

# ============================================================================
# 6. Rust Clippy 检查
# ============================================================================
echo -e "${GREEN}[6/6] 运行 Clippy...${NC}"
cargo clippy --all-features --all-targets -- -D warnings
echo -e "${GREEN}✅ Clippy 检查通过${NC}"
echo ""

# ============================================================================
# Rust 测试 (可选，因为耗时较长)
# ============================================================================
read -p "是否运行 Rust 测试? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo -e "${GREEN}[7/7] 运行 Rust 测试...${NC}"
  cargo test --all-features --verbose
  echo -e "${GREEN}✅ Rust 测试通过${NC}"
fi

echo ""
echo -e "${GREEN}===========================================${NC}"
echo -e "${GREEN}✅ 本地 CI 验证全部通过！${NC}"
echo -e "${GREEN}===========================================${NC}"
echo ""
echo "可以安全地推送到远程仓库了！"
