# 性能监控运维指南

## 概述

本文档面向运维人员，介绍如何监控和维护日志分析器的性能。

## 监控架构

```
┌─────────────────────────────────────────────────────────┐
│                   应用层                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │ 搜索引擎 │  │ 缓存系统 │  │ 状态同步 │             │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘             │
│       │             │             │                     │
└───────┼─────────────┼─────────────┼─────────────────────┘
        │             │             │
┌───────┼─────────────┼─────────────┼─────────────────────┐
│       │             │             │                     │
│  ┌────▼─────────────▼─────────────▼─────┐              │
│  │      MetricsCollector                 │              │
│  │  - 查询时间统计                       │              │
│  │  - 系统资源监控                       │              │
│  │  - 缓存性能追踪                       │              │
│  └────┬──────────────────────────────────┘              │
│       │                                                 │
│  ┌────▼──────────┐  ┌──────────────┐                  │
│  │ AlertingSystem│  │ Dashboard    │                  │
│  │ - 阈值检测    │  │ - 实时指标   │                  │
│  │ - 告警通知    │  │ - 趋势分析   │                  │
│  └───────────────┘  └──────────────┘                  │
│                                                         │
│  ┌──────────────────────────────────┐                 │
│  │ RecommendationEngine             │                 │
│  │ - 性能分析                        │                 │
│  │ - 优化建议                        │                 │
│  └──────────────────────────────────┘                 │
└─────────────────────────────────────────────────────────┘
```

## 关键性能指标（KPI）

### 1. 搜索性能指标

| 指标名称 | 目标值 | 告警阈值 | 说明 |
|---------|--------|---------|------|
| 搜索响应时间（p50） | < 150ms | > 200ms | 50% 查询的响应时间 |
| 搜索响应时间（p95） | < 300ms | > 500ms | 95% 查询的响应时间 |
| 搜索响应时间（p99） | < 500ms | > 1000ms | 99% 查询的响应时间 |
| 查询吞吐量 | > 100 qps | < 50 qps | 每秒查询数 |
| 超时率 | < 1% | > 5% | 超时查询占比 |

### 2. 缓存性能指标

| 指标名称 | 目标值 | 告警阈值 | 说明 |
|---------|--------|---------|------|
| L1 缓存命中率 | > 60% | < 40% | 内存缓存命中率 |
| L1 响应时间 | < 1ms | > 5ms | 内存缓存响应时间 |
| L2 缓存命中率 | > 40% | < 20% | Redis 缓存命中率（如启用） |
| 缓存淘汰率 | < 10% | > 30% | 缓存条目淘汰比例 |
| 缓存内存使用 | < 80% | > 90% | 缓存占用内存比例 |

### 3. 系统资源指标

| 指标名称 | 目标值 | 告警阈值 | 说明 |
|---------|--------|---------|------|
| CPU 使用率 | < 70% | > 80% | 平均 CPU 使用率 |
| 内存使用率 | < 80% | > 90% | 内存使用率 |
| 磁盘 I/O | < 70% | > 85% | 磁盘 I/O 使用率 |
| 索引大小 | - | > 10GB | 搜索索引占用空间 |

### 4. 状态同步指标（如启用）

| 指标名称 | 目标值 | 告警阈值 | 说明 |
|---------|--------|---------|------|
| 同步延迟 | < 50ms | > 100ms | 状态更新延迟 |
| 连接数 | - | > 90% 最大值 | WebSocket 连接数 |
| 消息丢失率 | 0% | > 0.1% | 消息传递失败率 |

## 监控数据收集

### 指标收集方式

系统自动收集性能指标，无需额外配置。指标存储在内存中，可通过以下方式访问：

1. **应用内仪表板**（推荐）
   - 位置：设置 → 性能监控
   - 实时显示关键指标
   - 提供趋势图表

2. **日志文件**
   - 位置：`src-tauri/logs/app.log.*`
   - 包含详细的性能事件
   - 支持日志聚合工具

3. **Sentry 集成**（可选）
   - 自动上报性能问题
   - 错误追踪和分析
   - 需要配置 DSN

### 指标查询示例

系统内部使用 `MetricsCollector` 收集指标：

```rust
// 查询统计信息
let stats = metrics_collector.get_query_timing_stats();
println!("平均查询时间: {}ms", stats.avg_query_time_ms);
println!("p95 查询时间: {}ms", stats.p95_query_time_ms);

// 系统资源
let system_metrics = metrics_collector.get_system_metrics();
println!("CPU 使用率: {}%", system_metrics.cpu_usage_percent);
println!("内存使用: {}MB", system_metrics.memory_used_mb);
```

## 告警配置

### 告警规则

告警规则在 `performance.toml` 中配置：

```toml
[monitoring.thresholds]
search_response_time_ms = 200
cache_response_time_ms = 50
sync_latency_ms = 100
cpu_usage_percent = 80
memory_usage_percent = 90
```

### 告警级别

| 级别 | 说明 | 响应时间 | 处理方式 |
|------|------|---------|---------|
| Critical | 严重影响服务 | 立即 | 立即处理 |
| High | 性能显著下降 | 15分钟内 | 优先处理 |
| Medium | 性能轻微下降 | 1小时内 | 计划处理 |
| Low | 潜在问题 | 24小时内 | 记录跟踪 |

### 告警通知

当前支持的通知方式：
- 应用内通知
- 日志记录
- Sentry 告警（如启用）

## 性能优化建议

### 自动优化建议

系统会根据运行状态自动生成优化建议。查看方式：
- 设置 → 性能监控 → 优化建议

### 常见优化建议

#### 1. 查询优化

**建议：** "检测到慢查询模式，建议优化查询语句"

**原因：** 某些查询模式导致响应时间过长

**处理：**
- 简化查询条件
- 使用更精确的关键词
- 启用查询缓存

#### 2. 索引优化

**建议：** "检测到频繁查询模式，建议创建专用索引"

**原因：** 某些查询频繁执行，可通过专用索引加速

**处理：**
- 启用索引优化器
- 手动创建专用索引
- 调整索引维护计划

#### 3. 缓存优化

**建议：** "缓存命中率低，建议增加缓存容量"

**原因：** 缓存容量不足，导致频繁淘汰

**处理：**
```toml
[cache]
l1_max_capacity = 5000  # 增加容量
l1_ttl_seconds = 7200   # 延长 TTL
```

#### 4. 资源分配

**建议：** "CPU 使用率高，建议增加并发限制"

**原因：** 并发查询过多，导致 CPU 过载

**处理：**
```toml
[concurrency]
max_concurrent_searches = 5  # 降低并发数
```

## 故障排查

### 搜索性能下降

**症状：**
- 搜索响应时间 > 500ms
- 查询超时率 > 5%

**排查步骤：**

1. **检查系统资源**
   ```bash
   # 查看 CPU 和内存使用
   # 检查磁盘 I/O
   ```

2. **检查缓存状态**
   - 查看缓存命中率
   - 检查缓存容量
   - 查看淘汰率

3. **检查并发查询**
   - 查看当前并发数
   - 检查查询队列长度

4. **检查索引状态**
   - 查看索引大小
   - 检查索引碎片

**解决方案：**
- 增加缓存容量
- 限制并发查询
- 优化索引
- 增加系统资源

### 内存使用过高

**症状：**
- 内存使用率 > 90%
- 频繁 GC 或内存告警

**排查步骤：**

1. **检查缓存配置**
   - 查看 L1 缓存大小
   - 检查缓存条目数

2. **检查索引大小**
   - 查看索引占用内存
   - 检查是否有内存泄漏

3. **检查并发操作**
   - 查看并发查询数
   - 检查索引构建任务

**解决方案：**
```toml
[cache]
l1_max_capacity = 500  # 减小缓存
l1_ttl_seconds = 1800  # 缩短 TTL

[concurrency]
max_concurrent_searches = 5  # 限制并发
```

### 缓存命中率低

**症状：**
- 缓存命中率 < 40%
- 频繁的缓存未命中

**排查步骤：**

1. **检查查询模式**
   - 查看查询分布
   - 检查是否有重复查询

2. **检查 TTL 配置**
   - 查看缓存过期时间
   - 检查淘汰策略

3. **检查缓存容量**
   - 查看缓存大小
   - 检查淘汰率

**解决方案：**
```toml
[cache]
l1_max_capacity = 2000  # 增加容量
l1_ttl_seconds = 7200   # 延长 TTL
```

## 性能趋势分析

### 关键趋势指标

定期（每周/每月）分析以下趋势：

1. **查询性能趋势**
   - 平均响应时间变化
   - 超时率变化
   - 吞吐量变化

2. **缓存效率趋势**
   - 命中率变化
   - 淘汰率变化
   - 内存使用变化

3. **系统资源趋势**
   - CPU 使用率变化
   - 内存使用率变化
   - 磁盘使用变化

### 容量规划

根据趋势数据进行容量规划：

**数据增长预测：**
- 当前索引大小
- 月增长率
- 预计 6 个月后大小

**资源需求预测：**
- 当前资源使用
- 增长趋势
- 预计资源需求

## 维护任务

### 日常维护

- [ ] 检查性能指标
- [ ] 查看告警日志
- [ ] 检查系统资源
- [ ] 查看优化建议

### 每周维护

- [ ] 分析性能趋势
- [ ] 清理过期索引
- [ ] 检查缓存效率
- [ ] 更新配置（如需要）

### 每月维护

- [ ] 性能基准测试
- [ ] 容量规划评估
- [ ] 配置优化审查
- [ ] 文档更新

## 最佳实践

1. **建立基线**：记录正常运行时的性能指标作为基线
2. **定期审查**：每周审查性能指标和告警
3. **主动优化**：根据优化建议主动调整配置
4. **容量规划**：提前规划资源需求
5. **文档记录**：记录所有配置变更和优化措施

## 联系支持

如遇无法解决的性能问题，请提供：
- 性能指标快照
- 系统配置信息
- 告警日志
- 优化建议列表
- 已尝试的解决方案

---

**文档版本：** 1.0  
**最后更新：** 2025-12-22
