name: PR Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # 验证版本号一致性
  version-check:
    name: Version Consistency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check version consistency
        run: |
          # 获取各个文件的版本号
          PACKAGE_VERSION=$(jq -r '.version' log-analyzer/package.json)
          CARGO_VERSION=$(grep '^version =' log-analyzer/src-tauri/Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          TAURI_VERSION=$(jq -r '.version' log-analyzer/src-tauri/tauri.conf.json)
          
          echo "Package.json version: $PACKAGE_VERSION"
          echo "Cargo.toml version: $CARGO_VERSION"
          echo "Tauri.conf.json version: $TAURI_VERSION"
          
          if [[ "$PACKAGE_VERSION" != "$CARGO_VERSION" || "$PACKAGE_VERSION" != "$TAURI_VERSION" ]]; then
            echo "❌ Version numbers are inconsistent!"
            echo "Please ensure all version numbers match across package.json, Cargo.toml, and tauri.conf.json"
            exit 1
          else
            echo "✅ All version numbers are consistent"
          fi

  # 验证构建准备
  build-validation:
    name: Build Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: log-analyzer/package-lock.json

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libayatana-appindicator3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      - name: Install dependencies
        run: |
          cd log-analyzer
          npm ci

      - name: Validate build configuration
        run: |
          cd log-analyzer
          npm run type-check
          npm run lint

      - name: Test build
        run: |
          cd log-analyzer
          npm run build

  # 检查发布准备状态
  release-readiness:
    name: Release Readiness Check
    runs-on: ubuntu-latest
    needs: [version-check, build-validation]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check release notes
        run: |
          if [[ -f "CHANGELOG.md" ]]; then
            echo "✅ CHANGELOG.md exists"
            
            # 检查是否有未记录的更改
            LATEST_TAG=$(git tag -l "v*" --sort=-v:refname | head -n 1)
            if [[ -n "$LATEST_TAG" ]]; then
              CHANGES=$(git log --oneline "$LATEST_TAG"..HEAD --grep="^feat\|^fix\|^perf\|^refactor" | wc -l)
              if [[ $CHANGES -gt 0 ]]; then
                echo "⚠️  Found $CHANGES potentially unreleased changes"
                echo "Consider updating CHANGELOG.md"
              fi
            fi
          else
            echo "⚠️  No CHANGELOG.md found"
          fi

      - name: Check for breaking changes
        run: |
          # 简单的破坏性变更检查
          BREAKING_CHANGES=$(git log --oneline --grep="BREAKING\|breaking" | wc -l)
          if [[ $BREAKING_CHANGES -gt 0 ]]; then
            echo "⚠️  Found $BREAKING_CHANGES potentially breaking changes"
            echo "Consider updating major version"
          fi