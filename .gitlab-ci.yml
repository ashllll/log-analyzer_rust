# GitLab CI/CD Pipeline for Log Analyzer
# 支持 Rust + Tauri + React 全栈项目

stages:
  - install
  - test
  - build
  - security
  - release

variables:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  NODE_VERSION: "22"
  # 缓存配置
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_REGISTRY_CACHE: $CI_PROJECT_DIR/.cargo/cache
  NPM_CONFIG_CACHE: $CI_PROJECT_DIR/.npm

# 全局缓存配置
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cargo/
    - .npm/
    - log-analyzer/node_modules/
    - log-analyzer/src-tauri/target/

# 基础镜像模板
.base_rust_template: &base_rust_template
  image: rust:1.70
  before_script:
    - apt-get update -qq && apt-get install -y -qq libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev

.base_node_template: &base_node_template
  image: node:18
  before_script:
    - npm ci

# Job: Rust 工具链安装
install:rust:
  stage: install
  <<: *base_rust_template
  script:
    - rustup component add rustfmt clippy
    - cargo --version
    - rustc --version
  artifacts:
    reports:
      dotenv: build.env
  tags:
    - docker

# Job: Node.js 依赖安装
install:frontend:
  stage: install
  <<: *base_node_template
  script:
    - cd log-analyzer
    - npm ci
  artifacts:
    paths:
      - log-analyzer/node_modules/
  tags:
    - docker

# Job: Rust 代码格式检查
test:rust:format:
  stage: test
  <<: *base_rust_template
  dependencies:
    - install:rust
  script:
    - cd log-analyzer/src-tauri
    - cargo fmt -- --check
  tags:
    - docker

# Job: Rust Clippy 检查
test:rust:clippy:
  stage: test
  <<: *base_rust_template
  dependencies:
    - install:rust
  script:
    - cd log-analyzer/src-tauri
    - cargo clippy --all-features --all-targets
  tags:
    - docker

# Job: Rust 单元测试
test:rust:unit:
  stage: test
  <<: *base_rust_template
  dependencies:
    - install:rust
  script:
    - cd log-analyzer/src-tauri
    - cargo test --all-features --verbose -- --nocapture
  coverage: '/(?i)TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      junit: log-analyzer/src-tauri/target/test-results.xml
    paths:
      - log-analyzer/src-tauri/target/debug/deps/
    expire_in: 1 week
  tags:
    - docker

# Job: Rust 基准测试
test:rust:bench:
  stage: test
  <<: *base_rust_template
  dependencies:
    - install:rust
  script:
    - cd log-analyzer/src-tauri
    - cargo test --bench -- --nocapture > benchmark-results.txt
  artifacts:
    paths:
      - log-analyzer/src-tauri/benchmark-results.txt
    expire_in: 1 month
  tags:
    - docker
  allow_failure: true

# Job: 前端 Lint 检查
test:frontend:lint:
  stage: test
  <<: *base_node_template
  dependencies:
    - install:frontend
  script:
    - cd log-analyzer
    - npm run lint
  tags:
    - docker

# Job: 前端类型检查
test:frontend:typecheck:
  stage: test
  <<: *base_node_template
  dependencies:
    - install:frontend
  script:
    - cd log-analyzer
    - npm run type-check
  tags:
    - docker

# Job: 前端测试
test:frontend:unit:
  stage: test
  <<: *base_node_template
  dependencies:
    - install:frontend
  script:
    - cd log-analyzer
    - npm test -- --coverage --watchAll=false
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: log-analyzer/coverage/cobertura-coverage.xml
      junit: log-analyzer/test-results.xml
    paths:
      - log-analyzer/coverage/
    expire_in: 1 week
  tags:
    - docker

# Job: 集成测试
test:integration:
  stage: test
  <<: *base_rust_template
  dependencies:
    - install:rust
    - install:frontend
  script:
    - cd log-analyzer/src-tauri
    - cargo test --test '*' --verbose
  artifacts:
    reports:
      junit: log-analyzer/src-tauri/target/test-results/integration.xml
    paths:
      - log-analyzer/src-tauri/target/debug/deps/
  tags:
    - docker

# Job: 安全扫描 - cargo audit
security:audit:
  stage: security
  <<: *base_rust_template
  dependencies:
    - install:rust
  script:
    - cargo install cargo-audit
    - cd log-analyzer/src-tauri
    - cargo audit --json > audit-report.json || true
  artifacts:
    paths:
      - log-analyzer/src-tauri/audit-report.json
    expire_in: 1 week
  tags:
    - docker
  allow_failure: true

# Job: 安全扫描 - 依赖检查
security:deps:
  stage: security
  <<: *base_rust_template
  dependencies:
    - install:rust
  script:
    - cargo install cargo-outdated cargo-udeps
    - cd log-analyzer/src-tauri
    - cargo outdated --format=json > outdated-report.json || true
    - cargo +nightly udeps --all-targets --output-format json > udeps-report.json || true
  artifacts:
    paths:
      - log-analyzer/src-tauri/outdated-report.json
      - log-analyzer/src-tauri/udeps-report.json
    expire_in: 1 week
  tags:
    - docker
  allow_failure: true

# Job: 构建 Linux
build:linux:
  stage: build
  <<: *base_rust_template
  dependencies:
    - install:rust
    - install:frontend
  script:
    - cd log-analyzer
    - npm run tauri build -- --target x86_64-unknown-linux-gnu
  artifacts:
    paths:
      - log-analyzer/src-tauri/target/release/bundle/deb/
      - log-analyzer/src-tauri/target/release/bundle/appimage/
    expire_in: 1 month
  tags:
    - docker
  only:
    - main
    - tags

# Job: 构建 macOS (需要 macOS runner)
build:macos:
  stage: build
  image: macos:latest
  dependencies:
    - install:rust
    - install:frontend
  script:
    - cd log-analyzer
    - npm run tauri build -- --target x86_64-apple-darwin
  artifacts:
    paths:
      - log-analyzer/src-tauri/target/release/bundle/dmg/
      - log-analyzer/src-tauri/target/release/bundle/macos/
    expire_in: 1 month
  tags:
    - macos
  only:
    - main
    - tags

# Job: 构建 Windows (需要 Windows runner)
build:windows:
  stage: build
  image: mcr.microsoft.com/windows/servercore:ltsc2022
  dependencies:
    - install:rust
    - install:frontend
  script:
    - cd log-analyzer
    - npm run tauri build -- --target x86_64-pc-windows-msvc
  artifacts:
    paths:
      - log-analyzer/src-tauri/target/release/bundle/msi/
      - log-analyzer/src-tauri/target/release/bundle/nsis/
    expire_in: 1 month
  tags:
    - windows
  only:
    - main
    - tags

# Job: 代码质量报告
quality:report:
  stage: build
  <<: *base_rust_template
  dependencies:
    - install:rust
  script:
    - cd log-analyzer/src-tauri
    - cargo install cargo-bloat cargo-deps
    - cargo bloat --release -- -n 20 > bloat-report.txt
    - cargo deps --tree --depth 1 > deps-tree.txt
    - cargo tree --depth 1 > cargo-tree.txt
    - echo "## 代码统计" > code-quality-report.md
    - echo "- 总行数: $(find src -name '*.rs' -exec wc -l {} + | tail -1 | awk '{print $1}')" >> code-quality-report.md
    - echo "- 测试用例数: $(find src -name '*.rs' -exec grep -l '#\[test\]' {} \; | wc -l)" >> code-quality-report.md
    - echo "- 模块数: $(find src -name 'mod.rs' | wc -l)" >> code-quality-report.md
    - echo "- 构建时间: $(cargo build --release 2>&1 | grep 'Finished' | awk '{print $2}')" >> code-quality-report.md
  artifacts:
    paths:
      - log-analyzer/src-tauri/bloat-report.txt
      - log-analyzer/src-tauri/deps-tree.txt
      - log-analyzer/src-tauri/cargo-tree.txt
      - log-analyzer/src-tauri/code-quality-report.md
    expire_in: 1 month
  tags:
    - docker

# Job: 发布到 GitLab Registry
release:registry:
  stage: release
  dependencies:
    - build:linux
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  only:
    - main
    - tags
  tags:
    - docker

# Job: 创建 GitLab Release
release:gitlab:
  stage: release
  dependencies:
    - build:linux
  script:
    - echo "创建 GitLab Release"
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --data "name=Release $CI_COMMIT_TAG" \
        --data "tag_name=$CI_COMMIT_TAG" \
        --data "description=Log Analyzer Release $CI_COMMIT_TAG" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
  only:
    - tags
  tags:
    - docker

# Job: 部署到生产环境 (需要配置)
deploy:production:
  stage: release
  dependencies:
    - build:linux
  script:
    - echo "部署到生产环境"
    - # 添加您的部署脚本
  environment:
    name: production
    url: https://your-domain.com
  only:
    - tags
  when: manual
  tags:
    - docker

# 失败通知
failure:notify:
  stage: .post
  script:
    - |
      curl -X POST \
        -H "Content-Type: application/json" \
        -d "{\"text\":\"CI/CD Pipeline 失败: $CI_PROJECT_NAME - $CI_COMMIT_REF_NAME\"}" \
        $SLACK_WEBHOOK_URL || echo "通知发送失败"
  when: on_failure
  tags:
    - docker
  allow_failure: true
